/*
 * QVTable.js
 * Copyright 2014, Tianyong Tang
 * Licensed under the MIT.
 */$(function(){function e(e){return $(e).find("tr").length}function t(e){var t=parseInt($(e).attr("rowspan"),10);return t>0?t:1}function n(e){var t=parseInt($(e).attr("colspan"),10);return t>0?t:1}function r(e,t){for(var n=0,r=e.length;n<r;n++)if(e[n]===t)return n;return-1}function i(e){var t=e.length,n=e[0].length,i=[],s=$("<table>");for(var o=0;o<t;++o){var u=$("<tr>"),a=n-1;while(a>=0){var f=e[o][a];if(f){if(r(i,f)<0){i[i.length]=f;u.prepend(f)}var l=$(f).data("location");a-=l.width}else a-=1}s.append(u)}return s}function s(e,t,n){e=$(e);var r=e.data("map");r.splice(t,n);var s=i(r);e.empty();e.append(s.children())}function o(r){r=$(r);var i=[];for(var s=0,o=e(r);s<o;++s)i[s]=[];r.find("tr").each(function(e){$(this).children("td").each(function(){var r=t(this),s=n(this),o=0,u=i[e];while(u[o])++o;for(var a=0;a<r;++a)for(var f=0;f<s;++f)i[e+a][o+f]=this;$(this).data("location",{top:e,left:o,right:o+s,bottom:e+r,width:s,height:r})})});r.data("map",i)}function u(e,t){e=$(e);t=t||0;o(e);var n=e.data("map"),r=n[0].length,i=n.length,s=r-t-1;while(s>=0){var a=i-1,f=n[a][s],l=[f],c=$(f).data("location");if(c.width===1){s-=1;continue}var h=c.left,p=c.right,d=c.width,v=!0;a-=1;while(a>=0){var m=n[a][s];if(m){var g=$(m).data("location");if(g.width<2){v=!1;break}h=Math.max(h,g.left);p=Math.min(p,g.right);d=Math.min(d,g.width);l[l.length]=m;a-=g.height}else a-=1}var y=p-h;d===y&&(y-=1);if(v&&y>0){$(l).each(function(e,t){t=$(t);var n=t.data("location");t.attr("colspan",n.width-y)});u(e,r-s-1);return}s-=1}}function a(e,t){e=$(e);t=t||0;o(e);var n=e.data("map"),r=n[0].length,i=n.length,u=i-t-1;while(u>=0){var f=r-1,l=n[u][f],c=[l],h=$(l).data("location");if(h.height===1){u-=1;continue}var p=h.top,d=h.bottom,v=h.height,m=!0;f-=1;while(f>=0){var g=n[u][f];if(g){var y=$(g).data("location");if(y.height<2){m=!1;break}p=Math.max(p,y.top);d=Math.min(d,y.bottom);v=Math.min(v,y.height);c[c.length]=g;f-=y.width}else f-=1}var b=d-p;v===b&&(b-=1);if(m&&b>0){s(e,u,b);$(c).each(function(e,t){t=$(t);var n=t.data("location");t.attr("rowspan",n.height-b)});a(e,i-u-1);return}u-=1}}function f(t){t=$(t);var n=[],r=t.closest("table"),i=e(r),s=t.data("location"),o=s.left,u=s.width,a=r.data("map"),f=0;while(f<i){var l=a[f][o],c=$(l).data("location");if(l!==t[0]){if(c.width-u<=0)return[];n[n.length]=l}f+=c.height}return n}function l(e){e=$(e);var t=n(e),r=f(e);if(r.length>0){$(r).each(function(){$(this).attr("colspan",n(this)-t)});e.remove();return!0}return!1}function c(e){e=$(e);var t=[],n=e.data("location");if(n.left>0){var r=n.left,i=e.closest("table").data("map"),s=n.top,o=n.bottom;while(s<o){var u=i[s][r-1];if(u){var a=$(u).data("location");if(a.top<n.top||a.bottom>n.bottom)return[];t[t.length]=u;s+=a.height}else++s}}return t}function h(e){e=$(e);var t=[],n=e.data("location"),r=n.top,i=n.bottom,s=n.right,o=e.closest("table").data("map");while(r<i){var u=o[r][s];if(u){var a=$(u).data("location");if(a.top<n.top||a.bottom>n.bottom)return[];t[t.length]=u;r+=a.height}else++r}return t}function p(e){e=$(e);var t=[],n=e.data("location");if(n.top>0){var r=n.top,i=n.left,s=n.right,o=e.closest("table").data("map");while(i<s){var u=o[r-1][i];if(u){var a=$(u).data("location");if(a.left<n.left||a.right>n.right)return[];t[t.length]=u;i+=a.width}else i+=1}}return t}function d(e){e=$(e);var t=[],n=e.data("location"),r=n.left,i=n.right,s=n.bottom,o=e.closest("table").data("map");while(r<i){var u=o[s][r];if(u){var a=$(u).data("location");if(a.left<n.left||a.right>n.right)return[];t[t.length]=u;r+=a.width}else r+=1}return t}function v(e){e=$(e);var t=e.data("location"),n=c(e);if(n.length>0){$(n).each(function(e,n){n=$(n);var r=n.data("location");n.attr("colspan",r.width+t.width)});e.remove();return!0}var r=h(e);if(r.length>0){$(r).each(function(e,n){n=$(n);var r=n.data("location");n.attr("colspan",r.width+t.width)});e.remove();return!0}return!1}function m(e){e=$(e);var t=e.data("location"),n=p(e);if(n.length>0){$(n).each(function(e,n){n=$(n);var r=n.data("location");n.attr("rowspan",r.height+t.height)});e.remove();return!0}var r=d(e);if(r.length>0){r=$(r);r.each(function(e,n){n=$(n);var r=n.data("location");n.attr("rowspan",r.height+t.height)});e.replaceWith(r);return!0}return!1}function g(e,t){e=$(e);var n=parseInt(t/2,10),r=t-n,i=e.data("location"),s=i.height,o=$('<td rowspan="'+s+'" colspan="'+r+'">N</td>');e.attr("colspan",n);o.insertAfter(e)}function y(e){e=$(e);var t=[],n=e.closest("table"),r=n.data("map"),i=r.length-1,s=e.data("location"),o=s.left;while(i>=0){var u=r[i][o];if(u){u!==e[0]&&(t[t.length]=u);var a=$(u).data("location");i-=a.height}else i-=1}t=$(t);t.each(function(e,t){t=$(t);var n=t.data("location");t.attr("colspan",n.width+1)});var f=s.height,l=s.width,c=$('<td rowspan="'+f+'" colspan="'+l+'">N</td>');c.insertAfter(e)}function b(e,t){e=$(e);var n=parseInt(t/2,10),r=t-n,s=e.data("location"),o=s.width,u=$('<td rowspan="'+r+'" colspan="'+o+'">N</td>'),a=e.closest("table"),f=a.data("map"),l=s.top+n,c=l+r,h=s.left;while(l<c){var p=o;while(p--)f[l][h+p]=u[0];l+=1}u.data("location",{top:s.top,left:h,right:h+o,bottom:s.top+r,width:o,height:r});var d=i(f);a.empty();a.append(d.children());e.attr("rowspan",n)}function w(e){e=$(e);var t=e.closest("table"),n=t.data("map"),r=e.data("location"),s=r.top,o=r.width,u=r.bottom,a=r.left,f=r.right,l=$('<td colspan="'+o+'">N</td>'),c=n[0].length-1,h=[],p=c;while(p>=0){var d=n[s][p];if(d){d!==e[0]&&(h[h.length]=d);var v=$(d).data("location");p-=v.width}else p-=1}p=c;var m=[];while(p>=0){var g=null;p<a||p>=f?g=n[s][p]:g=l[0];m[m.length]=g;p-=1}n.splice(u,0,m);l.data("location",{top:u,left:a,right:a+o,bottom:u+1,width:o,height:1});var y=i(n);t.empty();t.append(y.children());$(h).each(function(e,t){t=$(t);var n=t.data("location");t.attr("rowspan",n.height+1)})}function E(e){e=$(e);var t=e.closest("table");if(t.find("td").length<2)return;o(t);l(e)||v(e)||m(e);u(t);a(t)}function S(e,t){if(t.length<2)return;e=$(e);t=$(t);o(e);var n=$(t[0]).data("location"),r=n.top,s=n.left,f=n.right,l=n.bottom,c=0;t.each(function(e,t){t=$(t);var n=t.data("location");r=Math.min(r,n.top);s=Math.min(s,n.left);f=Math.max(f,n.right);l=Math.max(l,n.bottom);c+=n.width*n.height});var h=(f-s)*(l-r);if(c!==h)return;var p=e.data("map"),d=p[r][s],v=l;while(v-->r){var m=f;while(m-->s)p[v][m]=d}d=$(d);d.attr("rowspan",l-r);d.attr("colspan",f-s);var g=i(p);e.empty();e.append(g.children());u(e);a(e);t.toggleClass("highlight")}function x(e){e=$(e);var t=e.closest("table");o(t);var n=e.data("location"),r=n.width;r>1?g(e,r):y(e);e.toggleClass("highlight")}function T(e){e=$(e);var t=e.closest("table");o(t);var n=e.data("location"),r=n.height;r>1?b(e,r):w(e);e.toggleClass("highlight")}function N(e,t){e=$(e);var n=e.data("map"),r=n[0].length,s=n.length,o=t,u=null,a=[];if(o>0&&o<s){var f=r-1,l=o-1,c=0;while(f>=0){var h=n[l][f];if(h){h=$(h);var p=h.data("location"),d=p.bottom;d===o&&(c+=p.width);if(d!==o){var v=p.left,m=p.right;p.height+=1;h.attr("rowspan",p.height);h.data("location",p);while(v<m)a[v++]=h[0];if(c>0){v=m;m=v+c;u=$('<td rowspan="1" colspan="'+c+'">N</td>');u.data("location",{top:o,left:v,right:m,bottom:o+1,width:c,height:1});while(v<m)a[v++]=u[0];c=0}}f-=p.width}else f-=1;if(f<0&&c>0){u=$('<td rowspan="1" colspan="'+c+'">N</td>');u.data("location",{top:o,left:0,right:c,bottom:o+1,width:c,height:1});while(c--)a[c]=u[0]}}}else{u=$('<td rowspan="1" colspan="'+r+'">N</td>');u.data("location",{top:o,left:0,right:r,bottom:o+1,width:r,height:1});while(r--)a[r]=u[0]}n.splice(o,0,a);var g=i(n);e.empty();e.append(g.children())}function C(e,t){e=$(e);var n=e.data("map"),r=n[0].length,s=n.length,o=t,u=null;if(o>0&&o<r){var a=s-1,f=o-1,l=0;while(a>=0){var c=n[a][f];if(c){c=$(c);var h=c.data("location"),p=h.right;p===o&&(l+=h.height);if(p!==o){var d=h.top,v=h.bottom;h.width+=1;c.attr("colspan",h.width);c.data("location",h);while(d<v)n[d++].splice(o,0,c[0]);if(l>0){d=v;v=d+l;u=$('<td colspan="1" rowspan="'+l+'">N</td>');u.data("location",{top:d,left:o,right:o+1,bottom:v,width:1,height:l});while(d<v)n[d++].splice(o,0,u[0]);l=0}}a-=h.height}else a-=1;if(a<0&&l>0){u=$('<td colspan="1" rowspan="'+l+'">N</td>');u.data("location",{top:0,left:o,right:o+1,bottom:l,width:1,height:l});while(l--)n[l].splice(o,0,u[0])}}}else{u=$('<td colspan="1" rowspan="'+s+'">N</td>');u.data("location",{top:0,left:o,right:o+1,bottom:s,width:1,height:s});while(s--)n[s].splice(o,0,u[0])}var m=i(n);e.empty();e.append(m.children())}function k(e){e=$(e);var t=e.closest("table");o(t);var n=e.data("location");N(t,n.bottom);e.toggleClass("highlight")}function L(e){e=$(e);var t=e.closest("table");o(t);var n=e.data("location");N(t,n.top);e.toggleClass("highlight")}function A(e){e=$(e);var t=e.closest("table");o(t);var n=e.data("location");C(t,n.right);e.toggleClass("highlight")}function O(e){e=$(e);var t=e.closest("table");o(t);var n=e.data("location");C(t,n.left);e.toggleClass("highlight")}$("table#qv").on("click","td",function(){$(this).toggleClass("highlight")});$("button#remove").on("click",function(){$("table#qv td.highlight").each(function(){E(this)})});$("button#merge").on("click",function(){var e=$("table#qv");S(e,e.find("td.highlight"))});$("button#sliceH").on("click",function(){$("table#qv td.highlight").each(function(){x(this)})});$("button#sliceV").on("click",function(){$("table#qv td.highlight").each(function(){T(this)})});$("button#newRowA").on("click",function(){$("table#qv td.highlight").each(function(){k(this)})});$("button#newRowB").on("click",function(){$("table#qv td.highlight").each(function(){L(this)})});$("button#newColA").on("click",function(){$("table#qv td.highlight").each(function(){A(this)})});$("button#newColB").on("click",function(){$("table#qv td.highlight").each(function(){O(this)})})});